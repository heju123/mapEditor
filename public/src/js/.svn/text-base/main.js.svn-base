import React from 'react';
import $ from 'jQuery';
import ReactDom from 'react-dom';
import { Router, Route, Link, browserHistory,hashHistory,IndexRoute } from 'react-router';
import globalUtil from "./common/utils/globalUtil.js";
import cacheUtil from "./common/utils/cacheUtil.js";

import authorization from './authorization.js';
import Login from './login/login.js';
import App from './app.js';
import Index from './index.js';
import Test from './test/test.js';

const captureSearchContainer = (location, cb) => {
    require.ensure([], require => {
        cb(null, require('./modules/captureSearch/captureSearch.js').default);
    },'captureSearch');
};
const faceSearchContainer = (location, cb) => {
    require.ensure([], require => {
        cb(null, require('./modules/faceSearch/faceSearch.js').default);
    },'faceSearch');
};
const carSearchContainer = (location, cb) => {
    require.ensure([], require => {
        cb(null, require('./modules/carSearch/carSearch.js').default);
    },'carSearch');
};
const mapContainer = (location, cb) => {
    require.ensure([], require => {
        cb(null, require('./modules/map/map.js').default);
    },'map');
};
const blackListMgContainer = (location, cb) => {
    require.ensure([], require => {
        cb(null, require('./modules/blackListMg/blackListMg.js').default);
    },'blackListMg');
};

class Main extends React.Component{
    constructor(){
        super();
        //查询缓存
        let permit = cacheUtil.getCache("permit");
        authorization.permit = permit || authorization.permit;
        let currentUser = cacheUtil.getCache("currentUser");
        authorization.currentUser = currentUser;
    }

    requireCredentials(nextState, replace, next){
        if (!authorization.permit)
        {
            replace('/login');
        }
        next();
    }

    render(){
        return (
            <Router history={hashHistory}>
                <Route path="/login" component={Login}>
                </Route>
                <Route path="/" component={App}>
                    <IndexRoute component={Index} onEnter={this.requireCredentials.bind(this)}/>
                    <Route path="/test" component={Test}/>
                    <Route path="/captureSearch" getComponent={captureSearchContainer} onEnter={this.requireCredentials.bind(this)}/>
                    <Route path="/faceSearch" getComponent={faceSearchContainer} onEnter={this.requireCredentials.bind(this)}/>
                    <Route path="/carSearch" getComponent={carSearchContainer} onEnter={this.requireCredentials.bind(this)}/>
                    <Route path="/map" getComponent={mapContainer} onEnter={this.requireCredentials.bind(this)}/>
                    <Route path="/blackListMg" getComponent={blackListMgContainer} onEnter={this.requireCredentials.bind(this)}/>
                </Route>
            </Router>
        );
    }
}
$.getJSON("config.json", undefined, function (res) {
    globalUtil.baseServerPath = res.baseServerPath;
    ReactDom.render(<Main></Main>, document.getElementById("main"));
});