/**
 * Created by heju on 2017/2/10.
 */
import React from 'react';
import $ from 'jQuery';
import authorization from './authorization.js';
import {hashHistory} from 'react-router';
import commonUtil from "./common/utils/commonUtil.js";

require("../css/base.scss");
require("../css/home.scss");

export default class Header extends React.Component{
    constructor(){
        super();
        this.indexMenu = {
            icon : "top_menu_1",
            name : "服务状态",
            route : "/"
        };
        this.state = {
            systemName : "人脸搜索服务",
            menuList : [
                this.indexMenu,
                {
                    icon : "top_menu_2",
                    name : "抓拍查询",
                    route : "/captureSearch"
                },
                {
                    icon : "top_menu_2",
                    name : "车辆搜索",
                    route : "/carSearch"
                },
                {
                    icon : "top_menu_3",
                    name : "人脸搜索",
                    route : "/faceSearch"
                },
                {
                    icon : "top_menu_3",
                    name : "黑名单管理",
                    route : "/blackListMg"
                },
                {
                    icon : "top_menu_4",
                    name : "地图",
                    route : "/map"
                }
            ]
        };
    }

    routeToUrl(item){
        this.selectedMenu.select = false;
        this.selectedMenu = item;
        this.selectedMenu.select = true;
        hashHistory.push(item.route);
    }

    onClickLeftMenu(event){
        event.nativeEvent.stopImmediatePropagation();
    }

    componentDidMount(){
        $(document).click(()=>{
            $(this.refs.leftMenu).animate({left : "-146px"}, "fast", function(){});

            $(this.refs.currentUserBtn).removeClass("header-currentuser-on");
            $(this.refs.currentuserDropList).hide();
        });
    }

    openLeftMenuPanel(event){
        $(this.refs.leftMenu).animate({left : "0px"}, "fast", function(){});
        event.nativeEvent.stopImmediatePropagation();
    }

    onClickCurrentUser(event){
        $(this.refs.currentUserBtn).addClass("header-currentuser-on");
        $(this.refs.currentuserDropList).css({
            left : $(this.refs.currentUserBtn).offset().left,
            top : $(this.refs.currentUserBtn).offset().top + $(event.currentTarget).height() + 2,
            display : "block"
        });
        event.nativeEvent.stopImmediatePropagation();
    }

    logout(){
        commonUtil.popConfirmWindow({
            msg : "确定要注销吗？",
            okCallback : ()=>{
                authorization.logout();
            }
        });
    }

    render(){
        //设置当前选择菜单
        let currentPath = location.href.split("#")[1];
        let currentMenu = commonUtil.getArrayInfoByKey(this.state.menuList, "route", currentPath);
        if (this.selectedMenu)
        {
            this.selectedMenu.select = false;
        }
        this.selectedMenu = currentMenu || this.indexMenu;
        this.selectedMenu.select = true;

        let menuList = [];
        let leftMenuList = [];
        this.state.menuList.forEach((item, index) => {
            menuList.push(
                <div className={item.select ? "header-menu-item-on header-menu-item" : "header-menu-item"} onClick={this.routeToUrl.bind(this, item)}>
                    <div className={"header-menu-item-icon " + item.icon}></div>
                    <div className="header-menu-item-name">{item.name}</div>
                </div>);
            if (index < this.state.menuList.length - 1)
            {
                menuList.push(<div className="header-menu-item-separate"></div>);
            }

            leftMenuList.push(
                <div className="left-menu-item" onClick={this.routeToUrl.bind(this, item)}>
                    <span className={"left-menu-item-icon " + item.icon}></span>
                    <span className="left-menu-item-name">{item.name}</span>
                </div>
            );
        });

        return (
            <div className="header" ref="header">
                <div className="header-body" ref="headerBody">
                    <div className="left-menu-openbtn hj-normal-button hj-mini-button" onClick={this.openLeftMenuPanel.bind(this)}></div>
                    <div className="logo" ref="logo"></div>
                    <div className="sysname" ref="sysname">{this.state.systemName}</div>
                    <div className="header-right-top">
                        <div className="header-currentuser" ref="currentUserBtn" onClick={this.onClickCurrentUser.bind(this)}>
                            <span className="currentuser">{authorization.currentUser}</span>
                            <span className="currentuser-icon"></span>
                        </div>
                        <div className="currentuser-dropdownlist" ref="currentuserDropList">
                            <div className="currentuser-dropdownlist-item" onClick={this.logout.bind(this)}>
                                注销
                            </div>
                        </div>
                    </div>
                    <div className="header-menu">
                        {menuList}
                    </div>
                </div>
                <div ref="leftMenu" className="left-menu">
                    <div className="left-menu-bg" onClick={this.onClickLeftMenu.bind(this)}></div>
                    {leftMenuList}
                </div>
            </div>
        );
    }
}